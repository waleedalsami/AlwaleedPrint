<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø§Ù„ÙˆÙ„ÙŠØ¯ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©</title>
  <style>
    @font-face {
      font-family: 'Cairo';
      src: url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');
    }
    
    body {
      font-family: 'Cairo', Arial, sans-serif;
      background: linear-gradient(to bottom, #f0f8ff, #dfefff);
      margin: 0; 
      padding: 0;
      min-height: 100vh;
      color: #333;
    }
    
    .splash {
      text-align: center;
      padding: 100px 20px;
      animation: fadeIn 0.5s ease-in-out;
    }
    
    .splash img {
      width: 100px;
      height: 100px;
      margin-bottom: 20px;
    }
    
    .splash h1 {
      font-size: 2.2em;
      color: #0077aa;
      margin-bottom: 30px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    
    .splash button {
      background: #0077aa;
      color: white;
      border: none;
      padding: 12px 30px;
      font-size: 1.1em;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .splash button:hover {
      background: #005588;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .hidden { 
      display: none; 
    }
    
    .container {
      padding: 20px;
      max-width: 1000px;
      margin: 0 auto;
      animation: fadeIn 0.5s ease-in-out;
    }
    
    .file-input-container {
      margin: 25px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .file-input-container input[type="file"] {
      margin: 15px 0;
      padding: 10px;
      border: 2px dashed #0077aa;
      border-radius: 5px;
      width: 80%;
      max-width: 400px;
      text-align: center;
    }
    
    .file-input-container small {
      color: #666;
      font-size: 0.9em;
    }
    
    #loadingIndicator {
      text-align: center;
      margin: 20px 0;
      font-size: 1.1em;
      color: #0077aa;
    }
    
    .progress-container {
      width: 80%;
      margin: 15px auto;
      background: #f0f0f0;
      border-radius: 5px;
    }
    
    .progress-bar {
      height: 20px;
      border-radius: 5px;
      background: #0077aa;
      width: 0%;
      transition: width 0.3s;
    }
    
    .list-container {
      max-height: 500px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .list-container button {
      background: #0077aa;
      color: white;
      padding: 12px;
      border: none;
      border-radius: 5px;
      margin: 8px 0;
      width: 100%;
      font-size: 1em;
      text-align: right;
      transition: all 0.3s;
      cursor: pointer;
    }
    
    .list-container button:hover {
      background: #005588;
      transform: translateX(-5px);
    }
    
    .empty-list-message {
      text-align: center;
      color: #666;
      padding: 20px;
    }
    
    .error-message {
      text-align: center;
      color: #d9534f;
      padding: 20px;
      font-weight: bold;
      position: relative;
      padding-right: 30px;
    }
    
    .close-btn {
      position: absolute;
      left: 10px;
      top: 10px;
      cursor: pointer;
      font-size: 1.2em;
    }
    
    #studentDetails {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 15px rgba(0,0,0,0.1);
      padding: 25px;
      margin-top: 20px;
    }
    
    .back-btn {
      background: #666 !important;
      margin-bottom: 25px !important;
      padding: 10px 20px !important;
    }
    
    .back-btn:hover {
      background: #444 !important;
    }
    
    #studentName {
      color: #0077aa;
      font-size: 2em;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #0077aa;
      text-align: center;
    }
    
    #studentTable {
      width: 100%;
      border-collapse: collapse;
      margin: 25px 0;
      font-size: 1.1em;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
    }
    
    #studentTable th {
      background-color: #0077aa;
      color: white;
      text-align: center;
      padding: 15px;
      font-weight: 600;
      font-size: 1.1em;
    }
    
    #studentTable td {
      padding: 15px;
      border-bottom: 1px solid #dddddd;
      text-align: center;
      font-size: 1.05em;
    }
    
    #studentTable tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    #studentTable tr:hover {
      background-color: #f1f9ff;
    }
    
    .summary-row {
      background-color: #e6ffe6 !important;
      font-weight: bold;
    }
    
    .result-row {
      background-color: #fff9e6 !important;
      font-weight: bold;
    }
    
    .rank-row {
      background-color: #ffe6e6 !important;
      font-weight: bold;
    }
    
    .actions {
      margin-top: 30px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .actions button {
      margin: 5px;
      padding: 12px 25px;
      border: none;
      border-radius: 5px;
      background-color: #00aaff;
      color: white;
      font-size: 1em;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .actions button:hover {
      background-color: #0088cc;
      transform: translateY(-2px);
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0,0,0,.1);
      border-radius: 50%;
      border-top-color: #0077aa;
      animation: spin 1s ease-in-out infinite;
      margin-left: 10px;
    }
    
    h2 {
      color: #0077aa;
      font-size: 1.8em;
      margin: 25px 0 15px 0;
      text-align: center;
    }
    
    h3 {
      color: #005588;
      font-size: 1.5em;
      margin: 20px 0 15px 0;
      text-align: right;
    }
    
    .breadcrumb {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .breadcrumb-item {
      margin: 0 5px;
      color: #0077aa;
      cursor: pointer;
    }
    
    .breadcrumb-item:hover {
      text-decoration: underline;
    }
    
    .breadcrumb-separator {
      margin: 0 5px;
      color: #666;
    }
    
    /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø±Ø£Ø³ ÙˆØªØ°ÙŠÙŠÙ„ Ø§Ù„ØµÙØ­Ø© */
    .page-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .header-top {
      display: flex;
      justify-content: space-between;
      width: 100%;
      margin-bottom: 15px;
    }
    
    .header-box {
      width: 48%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      min-height: 60px;
      background: #f9f9f9;
    }
    
    .header-center {
      display: flex;
      justify-content: center;
      width: 100%;
      margin-bottom: 15px;
    }
    
    .logo-container {
      display: flex;
      align-items: center;
      cursor: pointer;
    }
    
    .logo-container img {
      width: 80px;
      height: 80px;
    }
    
    .header-bottom {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      min-height: 40px;
      background: #f9f9f9;
    }
    
    .header-title {
      font-weight: bold;
      margin-bottom: 5px;
      color: #0077aa;
    }
    
    .page-footer {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
    }
    
    .footer-box {
      width: 48%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      min-height: 50px;
      background: #f9f9f9;
    }
    
    /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ */
    .editable {
      border: 1px dashed #ccc;
      padding: 2px;
      min-width: 50px;
      min-height: 20px;
    }
    
    .editable:focus {
      outline: none;
      border-color: #0077aa;
      background: #f0f8ff;
    }
    
    .edit-actions {
      margin-top: 15px;
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    
    .edit-actions button {
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9em;
    }
    
    .save-btn {
      background: #28a745;
      color: white;
    }
    
    .cancel-btn {
      background: #dc3545;
      color: white;
    }
    
    .undo-btn {
      background: #ffc107;
      color: #212529;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
      
      .actions {
        flex-direction: column;
        gap: 10px;
      }
      
      .actions button {
        width: 100%;
        justify-content: center;
      }
      
      #studentTable {
        font-size: 1em;
      }
      
      #studentTable th, 
      #studentTable td {
        padding: 12px;
      }
      
      .header-top, .page-footer {
        flex-direction: column;
      }
      
      .header-box, .footer-box {
        width: 100%;
        margin-bottom: 10px;
      }
    }
    
    @media (max-width: 480px) {
      .file-input-container input[type="file"] {
        width: 95%;
      }
      
      #studentName {
        font-size: 1.6em;
      }
      
      #studentTable th, 
      #studentTable td {
        padding: 10px;
        font-size: 0.95em;
      }
      
      .actions button {
        padding: 10px 15px;
        font-size: 0.9em;
      }
      
      .logo-container img {
        width: 60px;
        height: 60px;
      }
    }
    
    /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
    @media print {
      body {
        background: none;
        font-size: 12pt;
      }
      
      .container {
        padding: 0;
        max-width: 100%;
      }
      
      #studentDetails {
        box-shadow: none;
        padding: 0;
      }
      
      #studentTable {
        font-size: 12pt;
        box-shadow: none;
      }
      
      #studentTable th {
        background-color: #0077aa !important;
        color: white !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      
      .actions, .breadcrumb, .edit-actions {
        display: none !important;
      }
      
      @page {
        size: A4;
        margin: 10mm;
      }
    }
  </style>
</head>
<body>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© -->
<div class="splash" id="splash">
  <img src="https://cdn-icons-png.flaticon.com/512/3135/3135755.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚"/>
  <h1>Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙˆÙ„ÙŠØ¯ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©</h1>
  <button onclick="showMain()">Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</button>
</div>

<!-- Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
<div class="container hidden" id="main">
  <h2>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨</h2>
  
  <div class="file-input-container">
    <label for="fileInput">Ø§Ø®ØªØ± Ù…Ù„Ù/Ù…Ù„ÙØ§Øª Excel ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨:</label>
    <input type="file" id="fileInput" accept=".xls,.xlsx" multiple/>
    <small>Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø«Ø§Ù†ÙŠ</small>
  </div>
  
  <div id="loadingIndicator" class="hidden">
    <span class="loading"></span> Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„ÙØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...
    <div class="progress-container">
      <div class="progress-bar" id="progressBar"></div>
    </div>
  </div>
  
  <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª -->
  <div id="filesSection" class="hidden">
    <h3>Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©</h3>
    <div class="list-container" id="filesList"></div>
  </div>
  
  <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø´ÙŠØªØ§Øª -->
  <div id="sheetsSection" class="hidden">
    <div class="breadcrumb" id="breadcrumb">
      <span class="breadcrumb-item" onclick="backToFiles()">Ø§Ù„Ù…Ù„ÙØ§Øª</span>
      <span class="breadcrumb-separator">/</span>
      <span id="currentFileName"></span>
    </div>
    <h3>Ø§Ù„Ø´ÙŠØªØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</h3>
    <div class="list-container" id="sheetsList"></div>
  </div>
  
  <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ -->
  <div id="studentsSection" class="hidden">
    <div class="breadcrumb" id="studentsBreadcrumb">
      <span class="breadcrumb-item" onclick="backToFiles()">Ø§Ù„Ù…Ù„ÙØ§Øª</span>
      <span class="breadcrumb-separator">/</span>
      <span class="breadcrumb-item" onclick="backToSheets()" id="studentsFileName"></span>
      <span class="breadcrumb-separator">/</span>
      <span id="currentSheetName"></span>
    </div>
    <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
    <div class="list-container" id="studentsList"></div>
    <div class="actions">
      <button onclick="exportAllStudentsAsSinglePDF()">
        <span style="font-size: 1.2em;">ğŸ“š</span> ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ù…Ù„Ù PDF ÙˆØ§Ø­Ø¯
      </button>
    </div>
  </div>
</div>

<!-- Ø´Ø§Ø´Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ -->
<div class="container hidden" id="studentDetails">
  <div class="breadcrumb" id="detailsBreadcrumb">
    <span class="breadcrumb-item" onclick="backToFiles()">Ø§Ù„Ù…Ù„ÙØ§Øª</span>
    <span class="breadcrumb-separator">/</span>
    <span class="breadcrumb-item" onclick="backToSheets()" id="detailsFileName"></span>
    <span class="breadcrumb-separator">/</span>
    <span class="breadcrumb-item" onclick="backToStudents()" id="detailsSheetName"></span>
    <span class="breadcrumb-separator">/</span>
    <span id="currentStudentName"></span>
  </div>
  
  <!-- Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© -->
  <div class="page-header">
    <div class="header-top">
      <div class="header-box" contenteditable="true">
        <div class="header-title">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</div>
        <div>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©</div>
      </div>
      
      <div class="header-box" contenteditable="true">
        <div class="header-title">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØµÙ„</div>
        <div>Ø§Ù„ØµÙ: Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ - Ø§Ù„ÙØµÙ„: Ø£</div>
      </div>
    </div>
    
    <div class="header-center">
      <div class="logo-container" onclick="changeLogo()">
        <img id="schoolLogo" src="https://cdn-icons-png.flaticon.com/512/3135/3135755.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©"/>
      </div>
    </div>
    
    <div class="header-bottom" contenteditable="true">
      <div class="header-title">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø©</div>
      <div>ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø© Ù‡Ù†Ø§</div>
    </div>
  </div>
  
  <h2 id="studentName"></h2>
  
  <table id="studentTable"></table>
  
  <!-- ØªØ°ÙŠÙŠÙ„ Ø§Ù„ØµÙØ­Ø© -->
  <div class="page-footer">
    <div class="footer-box" contenteditable="true">
      <div class="header-title">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø®Ø§ØµØ©</div>
      <div>ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø®Ø§ØµØ© Ù‡Ù†Ø§</div>
    </div>
    
    <div class="footer-box" contenteditable="true">
      <div class="header-title">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ±</div>
      <div>.................................</div>
    </div>
  </div>
  
  <div class="edit-actions hidden" id="editActions">
    <button class="save-btn" onclick="saveChanges()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
    <button class="cancel-btn" onclick="cancelEditing()">Ø¥Ù„ØºØ§Ø¡</button>
    <button class="undo-btn" onclick="undoChanges()">ØªØ±Ø§Ø¬Ø¹</button>
  </div>
  
  <div class="actions">
    <button onclick="startEditing()">
      <span style="font-size: 1.2em;">âœï¸</span> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    </button>
    <button onclick="downloadPDF()">
      <span style="font-size: 1.2em;">ğŸ“„</span> ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ PDF
    </button>
    <button onclick="printPage()">
      <span style="font-size: 1.2em;">ğŸ–¨ï¸</span> Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
    </button>
    <button onclick="backToStudents()">
      <span style="font-size: 1.2em;">â†©</span> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
    </button>
  </div>
</div>

<!-- Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<!-- Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ -->
<script>
// Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
let excelFiles = []; // ØªØ®Ø²ÙŠÙ† ÙƒØ§ÙØ© Ø§Ù„Ù…Ù„ÙØ§Øª
let currentFileIndex = -1;
let currentSheetIndex = -1;
let currentStudentIndex = -1;
let editHistory = [];
let currentHistoryIndex = -1;
let isEditing = false;
let originalData = null;

// Ø¨Ù†ÙŠØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù
class ExcelFile {
  constructor(name, data) {
    this.name = name;
    this.data = data;
    this.sheets = [];
  }
}

// Ø¨Ù†ÙŠØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´ÙŠØª
class ExcelSheet {
  constructor(name, data) {
    this.name = name;
    this.data = data;
    this.students = [];
  }
}

// Ø¨Ù†ÙŠØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨
class Student {
  constructor(name, data) {
    this.name = name;
    this.data = data;
    this.subjects = [];
    this.total = '';
    this.result = '';
    this.rank = '';
    this.headerLeft = 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø©\nØ§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©';
    this.headerRight = 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØµÙ„\nØ§Ù„ØµÙ: Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ - Ø§Ù„ÙØµÙ„: Ø£';
    this.headerBottom = 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø©\nÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø© Ù‡Ù†Ø§';
    this.footerLeft = 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø®Ø§ØµØ©\nÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø®Ø§ØµØ© Ù‡Ù†Ø§';
    this.footerRight = 'ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ±\n.................................'; 
    this.logoUrl = 'https://cdn-icons-png.flaticon.com/512/3135/3135755.png';
  }
}

// Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
function showMain() {
  document.getElementById('splash').classList.add('hidden');
  document.getElementById('main').classList.remove('hidden');
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„ÙØ§Øª Excel
document.getElementById('fileInput').addEventListener('change', function (e) {
  const files = Array.from(e.target.files);
  if (files.length === 0) return;
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¬Ù… Ø§Ù„Ù…Ù„ÙØ§Øª
  const maxSize = 5 * 1024 * 1024; // 5MB
  const largeFiles = files.filter(file => file.size > maxSize);
  
  if (largeFiles.length > 0) {
    showMessage('error', `Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5MB): ${largeFiles.map(f => f.name).join(', ')}`);
    return;
  }
  
  // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
  document.getElementById('loadingIndicator').classList.remove('hidden');
  document.getElementById('fileInput').disabled = true;
  
  // Ø¥Ø¹Ø¯Ø§Ø¯ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
  const progressBar = document.getElementById('progressBar');
  progressBar.style.width = '0%';
  
  // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
  excelFiles = [];
  
  let processedFiles = 0;
  const updateProgress = () => {
    const progress = (processedFiles / files.length) * 100;
    progressBar.style.width = `${progress}%`;
  };
  
  const promises = files.map(file => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const excelFile = new ExcelFile(file.name, workbook);
          
          // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø´ÙŠØªØ§Øª
          workbook.SheetNames.forEach(sheetName => {
            const sheetData = workbook.Sheets[sheetName];
            excelFile.sheets.push(new ExcelSheet(sheetName, sheetData));
          });
          
          excelFiles.push(excelFile);
          processedFiles++;
          updateProgress();
          resolve();
        } catch (error) {
          reject(new Error(`Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù ${file.name}: ${error.message}`));
        }
      };
      reader.onerror = () => reject(new Error(`Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù ${file.name}`));
      reader.readAsArrayBuffer(file);
    });
  });
  
  Promise.all(promises)
    .then(() => {
      if (excelFiles.length === 0) {
        showMessage('error', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„ÙØ§Øª ØµØ§Ù„Ø­Ø©');
      } else {
        showFilesList();
      }
    })
    .catch(error => {
      showMessage('error', error.message);
      console.error('Error:', error);
    })
    .finally(() => {
      document.getElementById('loadingIndicator').classList.add('hidden');
      document.getElementById('fileInput').disabled = false;
      document.getElementById('fileInput').value = ''; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ù‚Ù„ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
    });
});

// Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª
function showFilesList() {
  const filesList = document.getElementById('filesList');
  filesList.innerHTML = '';
  
  if (excelFiles.length === 0) {
    filesList.innerHTML = '<p class="empty-list-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§</p>';
    return;
  }
  
  excelFiles.forEach((file, index) => {
    const btn = document.createElement('button');
    btn.textContent = file.name;
    btn.onclick = () => showSheetsList(index);
    filesList.appendChild(btn);
  });
  
  document.getElementById('filesSection').classList.remove('hidden');
  document.getElementById('sheetsSection').classList.add('hidden');
  document.getElementById('studentsSection').classList.add('hidden');
}

// Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø´ÙŠØªØ§Øª Ù„Ù…Ù„Ù Ù…Ø¹ÙŠÙ†
function showSheetsList(fileIndex) {
  currentFileIndex = fileIndex;
  const file = excelFiles[fileIndex];
  const sheetsList = document.getElementById('sheetsList');
  sheetsList.innerHTML = '';
  
  if (file.sheets.length === 0) {
    sheetsList.innerHTML = '<p class="empty-list-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´ÙŠØªØ§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù</p>';
    return;
  }
  
  file.sheets.forEach((sheet, index) => {
    const btn = document.createElement('button');
    btn.textContent = sheet.name;
    btn.onclick = () => showStudentsList(fileIndex, index);
    sheetsList.appendChild(btn);
  });
  
  document.getElementById('currentFileName').textContent = file.name;
  document.getElementById('filesSection').classList.add('hidden');
  document.getElementById('sheetsSection').classList.remove('hidden');
  document.getElementById('studentsSection').classList.add('hidden');
}

// Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ù„Ø´ÙŠØª Ù…Ø¹ÙŠÙ†
function showStudentsList(fileIndex, sheetIndex) {
  currentFileIndex = fileIndex;
  currentSheetIndex = sheetIndex;
  
  const file = excelFiles[fileIndex];
  const sheet = file.sheets[sheetIndex];
  const studentsList = document.getElementById('studentsList');
  studentsList.innerHTML = '';
  
  // Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«
  const searchContainer = document.createElement('div');
  searchContainer.style.margin = '10px 0';
  searchContainer.innerHTML = `
    <input type="text" id="studentSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨..." 
           style="padding: 8px; width: 100%; border: 1px solid #ddd; border-radius: 5px;">
  `;
  studentsList.appendChild(searchContainer);
  
  document.getElementById('studentSearch').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const buttons = studentsList.querySelectorAll('button:not(:first-child)');
    
    buttons.forEach(btn => {
      const studentName = btn.textContent.toLowerCase();
      btn.style.display = studentName.includes(searchTerm) ? 'block' : 'none';
    });
  });
  
  // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´ÙŠØª Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨
  if (sheet.students.length === 0) {
    try {
      const rows = XLSX.utils.sheet_to_json(sheet.data, { header: 1 });
      
      // ØªØ®Ø·ÙŠ Ø§Ù„ØµÙÙˆÙ Ø§Ù„ÙØ§Ø±ØºØ©
      const validRows = rows.filter(row => row.length > 1 && row[1]);
      
      validRows.slice(1).forEach(row => {
        const studentName = row[1].toString().trim();
        if (studentName) {
          const student = new Student(studentName, row);
          
          // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø¯Ø±Ø¬Ø§Øª (Ø¨Ø¯Ø¡Ù‹Ø§ Ù…Ù† Ø§Ù„Ø¹Ù…ÙˆØ¯ 4)
          for (let i = 3; i < row.length - 3; i += 3) {
            if (rows[0][i]) {
              student.subjects.push({
                name: rows[0][i].toString().split('-')[0].trim() || `Ù…Ø§Ø¯Ø© ${i/3 + 1}`,
                col1: row[i] || '---',
                col2: row[i+1] || '---',
                col3: row[i+2] || '---'
              });
            }
          }
          
          // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ ÙˆØ§Ù„Ù†ØªÙŠØ¬Ø© ÙˆØ§Ù„ØªØ±ØªÙŠØ¨ (Ø¢Ø®Ø± 3 Ø£Ø¹Ù…Ø¯Ø©)
          student.total = row[row.length-3] || '---';
          student.result = row[row.length-2] || '---';
          student.rank = row[row.length-1] || '---';
          
          sheet.students.push(student);
        }
      });
    } catch (error) {
      showMessage('error', `Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø´ÙŠØª: ${error.message}`);
      console.error('Error processing sheet:', error);
    }
  }
  
  if (sheet.students.length === 0) {
    studentsList.innerHTML = '<p class="empty-list-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø§Ø¨ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø´ÙŠØª</p>';
  } else {
    sheet.students.forEach((student, index) => {
      const btn = document.createElement('button');
      btn.textContent = student.name;
      btn.onclick = () => showStudentDetails(fileIndex, sheetIndex, index);
      studentsList.appendChild(btn);
    });
  }
  
  document.getElementById('studentsFileName').textContent = file.name;
  document.getElementById('currentSheetName').textContent = sheet.name;
  document.getElementById('filesSection').classList.add('hidden');
  document.getElementById('sheetsSection').classList.add('hidden');
  document.getElementById('studentsSection').classList.remove('hidden');
}

// Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨
function showStudentDetails(fileIndex, sheetIndex, studentIndex) {
  currentFileIndex = fileIndex;
  currentSheetIndex = sheetIndex;
  currentStudentIndex = studentIndex;
  
  const file = excelFiles[fileIndex];
  const sheet = file.sheets[sheetIndex];
  const student = sheet.students[studentIndex];
  
  document.getElementById('main').classList.add('hidden');
  document.getElementById('studentDetails').classList.remove('hidden');
  
  // ØªØ­Ø¯ÙŠØ« Ù…Ø³Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„
  document.getElementById('detailsFileName').textContent = file.name;
  document.getElementById('detailsSheetName').textContent = sheet.name;
  document.getElementById('currentStudentName').textContent = student.name;
  
  document.getElementById('studentName').textContent = student.name;
  
  // ØªØ­Ø¯ÙŠØ« Ø±Ø£Ø³ ÙˆØªØ°ÙŠÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
  const headerBoxes = document.querySelectorAll('.header-box');
  headerBoxes[0].innerHTML = `<div class="header-title">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</div>${student.headerLeft}`;
  headerBoxes[1].innerHTML = `<div class="header-title">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØµÙ„</div>${student.headerRight}`;
  
  const headerBottom = document.querySelector('.header-bottom');
  headerBottom.innerHTML = `<div class="header-title">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø©</div>${student.headerBottom}`;
  
  const footerBoxes = document.querySelectorAll('.footer-box');
  footerBoxes[0].innerHTML = `<div class="header-title">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø®Ø§ØµØ©</div>${student.footerLeft}`;
  footerBoxes[1].innerHTML = `<div class="header-title">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ±</div>${student.footerRight}`;
  
  document.getElementById('schoolLogo').src = student.logoUrl;
  
  const table = document.getElementById('studentTable');
  table.innerHTML = `
    <tr>
      <th width="30%">Ø§Ù„Ù…Ø§Ø¯Ø©</th>
      <th width="23%">Ø§Ù„Ù…Ø­ØµÙ„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰</th>
      <th width="23%">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„</th>
      <th width="24%">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
    </tr>
  `;
  
  // Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ù…ÙˆØ§Ø¯ Ø§Ù„Ø·Ø§Ù„Ø¨
  student.subjects.forEach(sub => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${sub.name || '---'}</td>
      <td>${sub.col1 || '---'}</td>
      <td>${sub.col2 || '---'}</td>
      <td>${sub.col3 || '---'}</td>
    `;
    table.appendChild(tr);
  });
  
  // Ø¥Ø¶Ø§ÙØ© ØµÙÙˆÙ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ ÙˆØ§Ù„Ù†ØªÙŠØ¬Ø© ÙˆØ§Ù„ØªØ±ØªÙŠØ¨
  const additionalData = [
    { title: 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ', value: student.total, className: 'summary-row' },
    { title: 'Ø§Ù„Ù†ØªÙŠØ¬Ø©', value: student.result, className: 'result-row' },
    { title: 'Ø§Ù„ØªØ±ØªÙŠØ¨', value: student.rank, className: 'rank-row' }
  ];
  
  additionalData.forEach(item => {
    const tr = document.createElement('tr');
    tr.className = item.className;
    tr.innerHTML = `
      <td colspan="2"><strong>${item.title}</strong></td>
      <td colspan="2">${item.value}</td>
    `;
    table.appendChild(tr);
  });
  
  // Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
  document.getElementById('editActions').classList.add('hidden');
  isEditing = false;
}

// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø´Ø§Ø´Ø§Øª
function backToFiles() {
  document.getElementById('studentDetails').classList.add('hidden');
  document.getElementById('studentsSection').classList.add('hidden');
  document.getElementById('sheetsSection').classList.add('hidden');
  document.getElementById('filesSection').classList.remove('hidden');
  document.getElementById('main').classList.remove('hidden');
}

function backToSheets() {
  document.getElementById('studentDetails').classList.add('hidden');
  document.getElementById('studentsSection').classList.add('hidden');
  document.getElementById('sheetsSection').classList.remove('hidden');
  document.getElementById('filesSection').classList.add('hidden');
  document.getElementById('main').classList.remove('hidden');
}

function backToStudents() {
  document.getElementById('studentDetails').classList.add('hidden');
  document.getElementById('studentsSection').classList.remove('hidden');
  document.getElementById('sheetsSection').classList.add('hidden');
  document.getElementById('filesSection').classList.add('hidden');
  document.getElementById('main').classList.remove('hidden');
}

// Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
function startEditing() {
  if (isEditing) return;
  
  const file = excelFiles[currentFileIndex];
  const sheet = file.sheets[currentSheetIndex];
  const student = sheet.students[currentStudentIndex];
  
  // Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù„Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡Ø§
  originalData = JSON.parse(JSON.stringify(student));
  editHistory = [];
  currentHistoryIndex = -1;
  saveToHistory(student);
  
  // Ø¬Ø¹Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
  const table = document.getElementById('studentTable');
  const cells = table.querySelectorAll('td');
  
  cells.forEach(cell => {
    if (!cell.hasAttribute('colspan')) {
      cell.contentEditable = true;
      cell.classList.add('editable');
    }
  });
  
  // Ø¬Ø¹Ù„ Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„Ø±Ø£Ø³ ÙˆØ§Ù„ØªØ°ÙŠÙŠÙ„ Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
  const editableElements = document.querySelectorAll('[contenteditable="true"]');
  editableElements.forEach(el => {
    el.contentEditable = true;
    el.classList.add('editable');
  });
  
  // Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
  document.getElementById('editActions').classList.remove('hidden');
  isEditing = true;
}

// Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
function saveChanges() {
  if (!isEditing) return;
  
  const file = excelFiles[currentFileIndex];
  const sheet = file.sheets[currentSheetIndex];
  const student = sheet.students[currentStudentIndex];
  
  // Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„
  const table = document.getElementById('studentTable');
  const rows = table.querySelectorAll('tr:not(:first-child)');
  
  rows.forEach((row, rowIndex) => {
    const cells = row.querySelectorAll('td');
    
    if (rowIndex < student.subjects.length) {
      // ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ§Ø¯
      student.subjects[rowIndex].name = cells[0].textContent;
      student.subjects[rowIndex].col1 = cells[1].textContent;
      student.subjects[rowIndex].col2 = cells[2].textContent;
      student.subjects[rowIndex].col3 = cells[3].textContent;
    } else {
      // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ØŒ Ø§Ù„Ù†ØªÙŠØ¬Ø©ØŒ Ø§Ù„ØªØ±ØªÙŠØ¨)
      const additionalIndex = rowIndex - student.subjects.length;
      if (additionalIndex === 0) student.total = cells[3].textContent;
      else if (additionalIndex === 1) student.result = cells[3].textContent;
      else if (additionalIndex === 2) student.rank = cells[3].textContent;
    }
  });
  
  // Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø§Ù„Ø±Ø£Ø³ ÙˆØ§Ù„ØªØ°ÙŠÙŠÙ„
  const headerBoxes = document.querySelectorAll('.header-box');
  student.headerLeft = headerBoxes[0].innerHTML.replace('<div class="header-title">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</div>', '').trim();
  student.headerRight = headerBoxes[1].innerHTML.replace('<div class="header-title">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØµÙ„</div>', '').trim();
  
  const headerBottom = document.querySelector('.header-bottom');
  student.headerBottom = headerBottom.innerHTML.replace('<div class="header-title">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø©</div>', '').trim();
  
  const footerBoxes = document.querySelectorAll('.footer-box');
  student.footerLeft = footerBoxes[0].innerHTML.replace('<div class="header-title">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø®Ø§ØµØ©</div>', '').trim();
  student.footerRight = footerBoxes[1].innerHTML.replace('<div class="header-title">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ±</div>', '').trim();
  
  // Ø­ÙØ¸ Ø§Ù„Ø´Ø¹Ø§Ø±
  student.logoUrl = document.getElementById('schoolLogo').src;
  
  // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ
  saveToHistory(student);
  
  // Ø¥ÙŠÙ‚Ø§Ù ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
  cancelEditing();
  
  showMessage('success', 'ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
}

// Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
function cancelEditing() {
  if (!isEditing) return;
  
  // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©
  if (originalData) {
    const file = excelFiles[currentFileIndex];
    const sheet = file.sheets[currentSheetIndex];
    const student = sheet.students[currentStudentIndex];
    
    Object.assign(student, JSON.parse(JSON.stringify(originalData)));
    showStudentDetails(currentFileIndex, currentSheetIndex, currentStudentIndex);
  }
  
  // Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
  document.getElementById('editActions').classList.add('hidden');
  isEditing = false;
}

// Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø®ÙŠØ±
function undoChanges() {
  if (!isEditing || currentHistoryIndex <= 0) return;
  
  currentHistoryIndex--;
  const prevState = editHistory[currentHistoryIndex];
  
  const file = excelFiles[currentFileIndex];
  const sheet = file.sheets[currentSheetIndex];
  const student = sheet.students[currentStudentIndex];
  
  Object.assign(student, JSON.parse(JSON.stringify(prevState)));
  showStudentDetails(currentFileIndex, currentSheetIndex, currentStudentIndex);
  startEditing(); // Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
}

// Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ
function saveToHistory(student) {
  // Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ø³Ø¬Ù„ØŒ Ø§Ø­Ø°Ù ÙƒÙ„ Ù…Ø§ Ø¨Ø¹Ø¯Ù‡
  if (currentHistoryIndex < editHistory.length - 1) {
    editHistory = editHistory.slice(0, currentHistoryIndex + 1);
  }
  
  // Ø§Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  editHistory.push(JSON.parse(JSON.stringify(student)));
  currentHistoryIndex = editHistory.length - 1;
}

// ØªØºÙŠÙŠØ± Ø§Ù„Ø´Ø¹Ø§Ø±
function changeLogo() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = event => {
      const logoUrl = event.target.result;
      document.getElementById('schoolLogo').src = logoUrl;
      
      // Ø­ÙØ¸ Ø§Ù„Ø´Ø¹Ø§Ø± ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
      if (isEditing) {
        const file = excelFiles[currentFileIndex];
        const sheet = file.sheets[currentSheetIndex];
        const student = sheet.students[currentStudentIndex];
        student.logoUrl = logoUrl;
        saveToHistory(student);
      }
    };
    reader.readAsDataURL(file);
  };
  
  input.click();
}

// Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF Ù„Ø·Ø§Ù„Ø¨ ÙˆØ§Ø­Ø¯
function downloadPDF() {
  const file = excelFiles[currentFileIndex];
  const sheet = file.sheets[currentSheetIndex];
  const student = sheet.students[currentStudentIndex];
  
  // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ PDF Ù…Ø®ØµØµ
  const pdfContent = document.createElement('div');
  pdfContent.style.padding = '20px';
  pdfContent.style.fontFamily = "'Cairo', Arial, sans-serif";
  
  // Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨
  const studentName = document.createElement('h2');
  studentName.style.textAlign = 'center';
  studentName.style.color = '#0077aa';
  studentName.style.marginBottom = '20px';
  studentName.textContent = student.name;
  pdfContent.appendChild(studentName);
  
  // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
  const pdfTable = document.createElement('table');
  pdfTable.style.width = '100%';
  pdfTable.style.borderCollapse = 'collapse';
  pdfTable.style.marginBottom = '20px';
  
  // Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„
  const tableHeader = document.createElement('tr');
  tableHeader.innerHTML = `
    <th style="background-color: #0077aa; color: white; padding: 10px; text-align: center;">Ø§Ù„Ù…Ø§Ø¯Ø©</th>
    <th style="background-color: #0077aa; color: white; padding: 10px; text-align: center;">Ø§Ù„Ù…Ø­ØµÙ„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰</th>
    <th style="background-color: #0077aa; color: white; padding: 10px; text-align: center;">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„</th>
    <th style="background-color: #0077aa; color: white; padding: 10px; text-align: center;">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
  `;
  pdfTable.appendChild(tableHeader);
  
  // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ§Ø¯
  student.subjects.forEach(sub => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${sub.name || '---'}</td>
      <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${sub.col1 || '---'}</td>
      <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${sub.col2 || '---'}</td>
      <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${sub.col3 || '---'}</td>
    `;
    pdfTable.appendChild(tr);
  });
  
  // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
  const additionalData = [
    { title: 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ', value: student.total, className: 'summary-row' },
    { title: 'Ø§Ù„Ù†ØªÙŠØ¬Ø©', value: student.result, className: 'result-row' },
    { title: 'Ø§Ù„ØªØ±ØªÙŠØ¨', value: student.rank, className: 'rank-row' }
  ];
  
  additionalData.forEach(item => {
    const tr = document.createElement('tr');
    tr.style.backgroundColor = item.className === 'summary-row' ? '#e6ffe6' : 
                              item.className === 'result-row' ? '#fff9e6' : '#ffe6e6';
    tr.style.fontWeight = 'bold';
    tr.innerHTML = `
      <td colspan="2" style="padding: 10px; border: 1px solid #ddd; text-align: center;"><strong>${item.title}</strong></td>
      <td colspan="2" style="padding: 10px; border: 1px solid #ddd; text-align: center;">${item.value}</td>
    `;
    pdfTable.appendChild(tr);
  });
  
  pdfContent.appendChild(pdfTable);
  
  // Ø¥Ø¹Ø¯Ø§Ø¯ Ø®ÙŠØ§Ø±Ø§Øª PDF
  const opt = {
    margin: [10, 10, 10, 10],
    filename: `${student.name}_Ù†ØªÙŠØ¬Ø©.pdf`,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { 
      scale: 2,
      useCORS: true,
      letterRendering: true,
      logging: true,
      backgroundColor: '#FFFFFF'
    },
    jsPDF: { 
      unit: 'mm',
      format: 'a4',
      orientation: 'portrait',
      putOnlyUsedFonts: true
    },
    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] },
    enableLinks: true
  };
  
  // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„
  const loadingMessage = document.createElement('div');
  loadingMessage.style.textAlign = 'center';
  loadingMessage.style.padding = '50px';
  loadingMessage.innerHTML = `
    <h2>${student.name}</h2>
    <p><span class="loading"></span> Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ù…Ù„Ù PDF...</p>
  `;
  document.body.appendChild(loadingMessage);
  
  // Ø¥Ù†Ø´Ø§Ø¡ PDF
  html2pdf().set(opt).from(pdfContent).save()
    .then(() => {
      // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
      document.body.removeChild(loadingMessage);
    })
    .catch(err => {
      console.error('Error generating PDF:', err);
      document.body.removeChild(loadingMessage);
      showMessage('error', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF: ' + err.message);
    });
}

// ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ù…Ù„Ù PDF ÙˆØ§Ø­Ø¯
function exportAllStudentsAsSinglePDF() {
  const file = excelFiles[currentFileIndex];
  const sheet = file.sheets[currentSheetIndex];
  
  if (sheet.students.length === 0) {
    showMessage('error', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø§Ø¨ Ù„Ù„ØªØµØ¯ÙŠØ±');
    return;
  }
  
  showMessage('success', 'Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ù…Ù„Ù PDF ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨...');
  
  // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ PDF Ø±Ø¦ÙŠØ³ÙŠ
  const mainPdfContent = document.createElement('div');
  mainPdfContent.style.fontFamily = "'Cairo', Arial, sans-serif";
  
  // Ø¥Ø¶Ø§ÙØ© ØµÙØ­Ø© Ù„ÙƒÙ„ Ø·Ø§Ù„Ø¨
  sheet.students.forEach((student, index) => {
    // ØµÙØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨
    const studentPage = document.createElement('div');
    studentPage.style.padding = '20px';
    studentPage.style.pageBreakAfter = 'always';
    
    // Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨
    const studentName = document.createElement('h2');
    studentName.style.textAlign = 'center';
    studentName.style.color = '#0077aa';
    studentName.style.marginBottom = '20px';
    studentName.textContent = student.name;
    studentPage.appendChild(studentName);
    
    // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    const pdfTable = document.createElement('table');
    pdfTable.style.width = '100%';
    pdfTable.style.borderCollapse = 'collapse';
    pdfTable.style.marginBottom = '20px';
    
    // Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    const tableHeader = document.createElement('tr');
    tableHeader.innerHTML = `
      <th style="background-color: #0077aa; color: white; padding: 10px; text-align: center;">Ø§Ù„Ù…Ø§Ø¯Ø©</th>
      <th style="background-color: #0077aa; color: white; padding: 10px; text-align: center;">Ø§Ù„Ù…Ø­ØµÙ„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰</th>
      <th style="background-color: #0077aa; color: white; padding: 10px; text-align: center;">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„</th>
      <th style="background-color: #0077aa; color: white; padding: 10px; text-align: center;">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
    `;
    pdfTable.appendChild(tableHeader);
    
    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ§Ø¯
    student.subjects.forEach(sub => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${sub.name || '---'}</td>
        <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${sub.col1 || '---'}</td>
        <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${sub.col2 || '---'}</td>
        <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${sub.col3 || '---'}</td>
      `;
      pdfTable.appendChild(tr);
    });
    
    // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
    const additionalData = [
      { title: 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ', value: student.total, className: 'summary-row' },
      { title: 'Ø§Ù„Ù†ØªÙŠØ¬Ø©', value: student.result, className: 'result-row' },
      { title: 'Ø§Ù„ØªØ±ØªÙŠØ¨', value: student.rank, className: 'rank-row' }
    ];
    
    additionalData.forEach(item => {
      const tr = document.createElement('tr');
      tr.style.backgroundColor = item.className === 'summary-row' ? '#e6ffe6' : 
                                item.className === 'result-row' ? '#fff9e6' : '#ffe6e6';
      tr.style.fontWeight = 'bold';
      tr.innerHTML = `
        <td colspan="2" style="padding: 10px; border: 1px solid #ddd; text-align: center;"><strong>${item.title}</strong></td>
        <td colspan="2" style="padding: 10px; border: 1px solid #ddd; text-align: center;">${item.value}</td>
      `;
      pdfTable.appendChild(tr);
    });
    
    studentPage.appendChild(pdfTable);
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙØ­Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
    mainPdfContent.appendChild(studentPage);
  });
  
  // Ø¥Ø¹Ø¯Ø§Ø¯ Ø®ÙŠØ§Ø±Ø§Øª PDF
  const opt = {
    margin: [10, 10, 10, 10],
    filename: `${sheet.name}_Ù†ØªØ§Ø¦Ø¬_Ø§Ù„Ø·Ù„Ø§Ø¨.pdf`,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { 
      scale: 2,
      useCORS: true,
      letterRendering: true,
      logging: true,
      backgroundColor: '#FFFFFF'
    },
    jsPDF: { 
      unit: 'mm',
      format: 'a4',
      orientation: 'portrait',
      putOnlyUsedFonts: true
    },
    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] },
    enableLinks: true
  };
  
  // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„
  const loadingMessage = document.createElement('div');
  loadingMessage.style.textAlign = 'center';
  loadingMessage.style.padding = '50px';
  loadingMessage.innerHTML = `
    <h2>Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ù…Ù„Ù PDF Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨</h2>
    <p><span class="loading"></span> Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...</p>
  `;
  document.body.appendChild(loadingMessage);
  
  // Ø¥Ù†Ø´Ø§Ø¡ PDF
  html2pdf().set(opt).from(mainPdfContent).save()
    .then(() => {
      // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
      document.body.removeChild(loadingMessage);
    })
    .catch(err => {
      console.error('Error generating PDF:', err);
      document.body.removeChild(loadingMessage);
      showMessage('error', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF: ' + err.message);
    });
}

// Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØµÙØ­Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
function printPage() {
  window.print();
}

// Ø¹Ø±Ø¶ Ø±Ø³Ø§Ø¦Ù„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
function showMessage(type, message) {
  const container = document.createElement('div');
  container.className = type === 'error' ? 'error-message' : 'empty-list-message';
  container.style.position = 'relative';
  container.style.paddingRight = '30px';
  
  const closeBtn = document.createElement('span');
  closeBtn.className = 'close-btn';
  closeBtn.textContent = 'Ã—';
  closeBtn.onclick = () => container.remove();
  
  container.appendChild(closeBtn);
  container.appendChild(document.createTextNode(message));
  
  const mainContainer = document.getElementById('main');
  mainContainer.insertBefore(container, mainContainer.firstChild);
  
  // Ø¥Ø²Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ø¹Ø¯ 10 Ø«ÙˆØ§Ù†ÙŠ ÙÙ‚Ø· Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ø§Ù„Ù…Ù‡Ù…Ø©
  if (type === 'error') {
    setTimeout(() => {
      if (document.body.contains(container)) {
        container.remove();
      }
    }, 10000);
  }
}
</script>
</body>
</html>